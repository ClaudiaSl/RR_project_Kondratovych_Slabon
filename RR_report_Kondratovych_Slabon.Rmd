---
title: "RR_report_Kondratovych_Slabon"
author: "Claudia Słaboń, Kateryna Kondratovych"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r libraries, include=FALSE}
library(ggthemes)
library(tibble)
library(lubridate)
library(dplyr)
library(ggpubr)
library(reshape)
library(scales)
library(plotly)
library(maps)
library(gganimate)
library(tidyverse)
library(rvest)
library(rlist)
library(stringi)
library(htmltab)
library(zoo)
library(dplyr)
library(tidyr)
library(xts)
library(dygraphs)
library(RColorBrewer)
library(ggplot2)
library(rgdal)
library(sf)
library(readxl)
library(viridis)
library(cowplot)
library(forecast) 

```

## COVID-19 and it’s impact on unemployment rate
<font size="4">
The first cases of COVID-19 comes from China (Wuhan) and were discovered in November 2019. From the beginning of the 2020 new outbreaks of the coronavirus have started to appear in other countries. The pandemic spread around the world rapidly. The discovery of the easily contagious virus forced on the world's government to take an fast and unconventional actions. Many countries have closed their borders and introduced lockdown. Due to such actions many economies suffer from a pandemic. \
The aim of this report is to discover whether the COVID-19 had an impact on unemployment. Firsly, it will be examined from the point of view of OECD countries, G7 countries, the USA. After that, the situation in Poland will be presented.

Dataset sources: \
- Wikipedia information regarding coronavirus cases. \
- Monthly unemployment rate in OECD countries comes from the OECD website. \
- Poland unemployment rate in voivodships comes from Poland's Central Statistical Office. \
- Poland map was built from dataset introduced during the classes. \
<font>
```{r datasets, echo=FALSE, results='hide'}
# Datasets that should be updated
data_unemp <- read.csv("Dane/DP_LIVE_09062021091719878.csv")
data_covid <- read.csv("Dane/covid-19-all.csv")

rate <- read.csv('Dane/MW_new.csv')
rate <- rate[c(1,3,6,7)]
rate <- transform(rate, TIME = as.Date(as.yearmon(TIME)))

eduk <- read.csv('Dane/eduk.csv',stringsAsFactors = FALSE)
eduk <- eduk[c(1,3,6,7)]
eduk <- transform(eduk, TIME = as.Date(as.yearmon(TIME)))

agek <- read.csv('Dane/agek.csv')
agek <- agek[c(1,3,6,7)]
agek <- transform(agek, TIME = as.Date(as.yearmon(TIME)))

unemp <- read.csv('Dane/unemp.csv')
unemp <- unemp[c(1,6,7)]
unemp <- transform(unemp, TIME = as.Date(as.yearmon(TIME)))
```

# COVID-19 spread

```{r}
# Statistics - updated from Wikipedia

url <- "https://en.m.wikipedia.org/wiki/COVID-19_pandemic_by_country_and_territory#"
# Scraping Wikipedia page using CSS selector in order to obtain current number of COVID cases and deaths
current_cases_all <- url %>%
  read_html() %>%
  html_node(css = "#thetable > tbody > tr.sorttop > th:nth-child(3)") %>%
  html_text()

current_cases_all <- as.numeric(gsub(",", "", current_cases_all))

current_deaths_all <- url %>%
  read_html() %>%
  html_node(css = "#thetable > tbody > tr.sorttop > th:nth-child(4)") %>%
  html_text()

current_deaths_all <- as.numeric(gsub(",", "", current_deaths_all))

# Creating new date frame containing 3 countries with the highest number of COVID cases from Wikipedia
top_covid_countries <- data.frame(Country = character(), cases = character(), stringsAsFactors = FALSE)
# Based on tested CSS variable i needs to start from 3
i <- 3

for (j in 1:3) {
  top_covid_countries <- rbind(
    top_covid_countries,
    data.frame(
      Country = url %>%
        read_html() %>%
        html_node(css = paste0("#thetable > tbody > tr:nth-child(", i, ") > th:nth-child(2) > a")) %>%
        html_text(),
      cases = url %>%
        read_html() %>%
        html_node(css = paste0("#thetable > tbody > tr:nth-child(", i, ") > td:nth-child(3)")) %>%
        html_text()
    )
  )

  i <- i + 1
}


```
<font size="4">
Although, the first cases of coronavirus were discover in China in the late of 2019, the pandemic rapidly spread around the whole world. Currently, there is **`r format(current_cases_all,big.mark=",",scientific=FALSE)`** coronavirus cases, **`r format(current_deaths_all,big.mark=",",scientific=FALSE)`** people died (`r format(Sys.time(), '%d %B, %Y')` update). \
Official top 3 countries with **highest** COVID-19 cases number: \
- `r top_covid_countries[1,1]` (`r toString(top_covid_countries[1,2])` cases), \
- `r top_covid_countries[2,1]` (`r toString(top_covid_countries[2,2])` cases), \
- `r top_covid_countries[3,1]` (`r toString(top_covid_countries[3,2])` cases). \
<font>
```{r, echo=FALSE, results='hide'}
# Selecting date of the unemployment analysis in OECD countries.
unemp_analysis_date <- data_unemp %>% select(TIME) %>% distinct() %>% pull(1) %>% sort()
n <- nth(unemp_analysis_date, -2) 
n
```


```{r changing, echo=FALSE, results='hide'}
data_covid$Date <- as.Date(data_covid$Date, format = "%Y-%m-%d")
data <- data_covid %>%
  filter(Date < as.Date("2021-01-01"))
summary(data)
data_agg <- aggregate(cbind(Confirmed, Recovered, Deaths)~week(Date)+Country.Region+Latitude+Longitude,
          data=data,FUN=max)
data_agg$`week(Date)` <- as.numeric(data_agg$`week(Date)`)
data_agg2 <- aggregate(cbind(Confirmed, Recovered, Deaths)~week(Date)+Country.Region,
                      data=data,FUN=max)
```

# Unemployment rate in OECD countries
<font size="4">
Below graphs present the situation of unemployment rate in OECD countries. It means that the unemployment rate is captured in 37 countries.
<font>
```{r oecd, echo=FALSE, fig.align='center', results='hide', message = FALSE, fig.width = 8, fig.height = 8}
colnames(data_unemp)[1] <- "Country"

plot_unemp19 <- data_unemp %>%
  filter(TIME == nth(unemp_analysis_date, -14) & Country != "EU28" & Country != "EA19" & Country != "EU27_2020")%>%
  select(Country, Value) %>%
  arrange(desc(Value)) %>%
  top_n(15) %>%
  arrange(Value) %>%
  mutate(Country = factor(Country, levels = .$Country)) %>%
  ggplot(aes(x=Country, y=Value)) +
  geom_segment( aes(x=Country, xend=Country, y=0, yend=Value), color="black") +
  scale_y_continuous(labels=function(x) paste0(x,"%")) +
  geom_point( color="skyblue", size=4) +
  theme_light() +
  coord_flip() +
  labs(title="Highest unemployment rate in 09/2019")+
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5))
plot_unemp20 <- 
 data_unemp %>%
  filter(TIME == "2020-09" & Country != "EU28" & Country != "EA19" & Country != "EU27_2020" & Country != "OECD")%>%
  select(Country, Value) %>%
  arrange(desc(Value)) %>%
  top_n(15) %>%
  arrange(Value) %>%
  mutate(Country = factor(Country, levels = .$Country)) %>%
  ggplot(aes(x=Country, y=Value)) +
  geom_segment( aes(x=Country, xend=Country, y=0, yend=Value), color="black") +
  scale_y_continuous(labels=function(x) paste0(x,"%")) +
  geom_point( color="skyblue", size=4) +
  theme_light() +
  coord_flip() +
  labs(title="Highest unemployment rate in 09/2020")+
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5))
plot_unem_1920_diff <- data_unemp %>%
  filter(TIME == "2019-09" | TIME == "2020-09") %>%
  select(Country,TIME, Value) %>%
  cast(Country~TIME) %>%
  filter(Country != "G-7" & Country != "EU28" & Country != "EA19" & Country != "EU27_2020" & Country != "OECD") %>%
  mutate(diff=`2020-09` - `2019-09`) %>%
  arrange(desc(diff)) %>%
  mutate(Country = factor(Country, levels = .$Country)) %>%
  top_n(15) %>%
  ggplot(aes(x = factor(Country), y = diff)) +
  geom_bar(na.rm = TRUE, width = 0.7, stat = "identity", aes(fill = diff))+
  expand_limits(y = c(0, 6.5)) +
  geom_text(aes(label = paste0(round(diff,1),"%")), vjust=-0.25, size =3) +
  scale_y_continuous(labels=function(x) paste0(x,"%")) +
  scale_fill_gradient2(low='lightblue', mid='lightblue', high='#1167b1') +
  labs(title = "The greatest change in unemployment rate between 09/2019 and 09/2020",
       caption = "Data comes from OECD which monitores unemployment in 37 countries.") +
  theme(legend.title = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0))
ggarrange(ggarrange(plot_unemp19, plot_unemp20, ncol = 2),
          plot_unem_1920_diff, 
          nrow = 2)
```

# Country-specific unemployment rate
<font size="4">
One can chose any country and get country-specific report
<font>
```{r pressure, echo=FALSE,results='hide'}
country="POL"
rate <- read.csv('Dane/MW_new.csv')
rate <- rate[c(1,3,6,7)]
rate <- transform(rate, TIME = as.Date(as.yearmon(TIME)))

eduk <- read.csv('Dane/eduk.csv',stringsAsFactors = FALSE)
eduk <- eduk[c(1,3,6,7)]
eduk <- transform(eduk, TIME = as.Date(as.yearmon(TIME)))

agek <- read.csv('Dane/agek.csv')
agek <- agek[c(1,3,6,7)]
agek <- transform(agek, TIME = as.Date(as.yearmon(TIME)))

unemp <- read.csv('Dane/unemp.csv')
unemp <- unemp[c(1,6,7)]
unemp <- transform(unemp, TIME = as.Date(as.yearmon(TIME)))
unemp<-subset(unemp, unemp$LOCATION==country)
unemp <- xts(unemp$Value,unemp$TIME)

unique(rate$X.LOCATION)
wide_DF<-subset(rate, rate$X.LOCATION==country)
wide_DF <- wide_DF %>% spread(SUBJECT, Value)
head(wide_DF, 24)
MEN <- xts(wide_DF$MEN, wide_DF$TIME)
WOMEN <- xts(wide_DF$WOMEN, wide_DF$TIME)
mw <-cbind(MEN, WOMEN)

eduk<-subset(eduk, eduk$LOCATION==country)
agek<-subset(agek, agek$LOCATION==country)

a <- dygraph(mw, main = paste("Unemployment rate in",country)) %>%
  dySeries("MEN", axis = "y2") %>%
  dyAxis(name = "y",independentTicks = T,
         axisLabelFormatter = "function(num){return num.toLocaleString() + '%'}",
         valueFormatter = "function(num){return num.toLocaleString() + '%'}") %>%
  dyAxis(name = "y2", independentTicks = T,drawGrid = T,
         axisLabelFormatter = "function(num){return num.toLocaleString() + '%'}",
         valueFormatter = "function(num){return num.toLocaleString() + '%'}") %>%
  dyEvent("2019-12-31", "First COVID case in world", labelLoc = "bottom") %>%
  dyEvent("2008-09-15", "Bankruptcy of Lehman Brothers", labelLoc = "bottom") %>%
  dyRangeSelector(dateWindow = c("2019-01-01", "2020-12-31"), fillColor = "#7570B3") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(3, "Dark2"), axisLineColor = "navy", 
            gridLineColor = "lightblue")

```

```{r a, echo=FALSE}
a
```

```{r pro, echo=FALSE,results='hide'}
edu <-eduk %>%
  ggplot(aes(x = TIME, y = Value, color = SUBJECT)) +
  geom_line(size=1)+ theme_light() +
  scale_color_brewer(palette = "Dark2",labels = c("Below upper secondary", "Tertiary", "Upper secondary")) +
  labs(x = "Year", y = "Unemployment Rate",
       title = paste("By education level(",country,")"))+
  theme(plot.title = element_text(hjust = 1, size = 19, face = "bold.italic"),
        axis.title.x = element_text(size = 10, face = "bold.italic"),
        axis.title.y = element_text(size = 10, face = "bold.italic"),
        legend.title = element_blank(),
        legend.position = "bottom") +
  scale_y_continuous(label = function(x) {return(paste(x, "%"))})


age <- agek %>%
  ggplot(aes(x = TIME, y = Value, color = SUBJECT))  +
  geom_line(size=1)+ theme_light() +
  scale_color_brewer(palette = "Dark2", labels= c("15-24","25-74")) +
  labs(x = "Year", y = "Unemployment Rate",
       title = paste("By age(",country, ")"))+
  theme(plot.title = element_text(hjust = 1, size = 19, face = "bold.italic"),
        axis.title.x = element_text(size = 10, face = "bold.italic"),
        axis.title.y = element_text(size = 10, face = "bold.italic"),
        legend.title = element_blank(),
        legend.position = "bottom") +
  scale_y_continuous(label = function(x) {return(paste(x, "%"))})

mycolors = c(brewer.pal(name="Dark2", n = 8), brewer.pal(name="Paired", n = 8))
```

```{r final graphs, echo=FALSE}
plot_grid(edu, age,rel_heights = c(1.9,2) )
```

## Forecast

We also did some forecasting using ARIMA. We used function auto-arima to find the best parameters.
```{r f, echo=FALSE}
head(unemp)
UR_ts <- ts(unemp[, 1], start = c(1997, 1), frequency = 12)
autoplot(UR_ts)
autoplot(diff(UR_ts))
ggAcf(diff(UR_ts))

# Find value for lamda to transform data and stablize variance
# See DataCamp/Forecasting Using R/Forecasting with ARIMA/Transformation for variance stabilization
# Lamda should range bt -1 (strong transformation, inverse) and 1 (no transformation)
bc<-BoxCox.lambda(UR_ts)
bc
ifelse(bc>-1&bc<1,"ok","not ok")
# Fit a seasonal ARIMA model 
fit1 <- auto.arima(UR_ts, trace =TRUE)
fit2 <- auto.arima(UR_ts, stepwise = FALSE) 
# stepwise = FALSE to make auto.arima() work harder to find a good model from a larger collection of models

# Summarize the fitted model
summary(fit1)
summary(fit2)

with_theme_light <- function(expr) {
  orig <- theme_get()
  theme_set(theme_cowplot())
  force(expr)
  theme_set(orig)
}

with_theme_light(checkresiduals(fit1, color = "red", size =2))
with_theme_light(checkresiduals(fit2, color = "red", size =2))
checkresiduals(fit1)
checkresiduals(fit2)

# Plot 2-year forecasts
fit1 %>% forecast(h = 24)

fit2 %>% forecast(h = 24)

arima1 <- fit1 %>% forecast(h = 24) %>% autoplot() + theme_cowplot() + xlab("Date") + ylab("Unemployment Rate")+
  scale_y_continuous(limits = c(0, NA), label = function(x) {return(paste(x, "%"))})
arima2 <- fit2 %>% forecast(h = 24) %>% autoplot() + theme_cowplot() + xlab("Date") + ylab("Unemployment Rate")+
  scale_y_continuous(limits = c(0, NA), label = function(x) {return(paste(x, "%"))})

plot_grid(arima1, arima2)
```

We can see that the residuals are normally distributed and we can forecast.
By both models unemployment will go down and it is in line with our expectations.
